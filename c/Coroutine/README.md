# c è¯­è¨€å®ç°åç¨‹  
[è‹±æ–‡åŸç‰ˆ](https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html)  
*by [Simon Tatham](http://pobox.com/~anakin/)*  

## ç®€ä»‹  
é€šå¸¸ï¼Œæ„å»ºå¤§å‹ç¨‹åºæ˜¯ä¸€ä»¶å¾ˆå›°éš¾çš„äº‹æƒ…ã€‚æ­¤å¤„å±•ç¤ºä¸€ä¸ªç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼š*å¦‚æœï¼Œä½ å†™äº†ä¸€æ®µä»£ç ç”¨äºäº§ç”Ÿæ•°æ®ï¼Œå¦ä¸€æ®µä»£ç ç”¨äºæ¶ˆè´¹äº§ç”Ÿçš„æ•°æ®ï¼Œé‚£ä¹ˆåº”è¯¥è®©è°è°ƒç”¨è°å‘¢ï¼Ÿ*
> æ­¤å¤„è‡ªç„¶è”æƒ³åˆ°äº†`ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹`ï¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹å’Œä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªç”¨äºäº§ç”Ÿæ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºæ¶ˆè´¹æ•°æ®ï¼ŒäºŒè€…ä¸èƒ½åŒæ—¶æ“ä½œé˜Ÿåˆ—(é”)  

ä¸‹é¢æ˜¯ä¸€æ®µéå¸¸ç®€å•çš„ï¼Œè¡Œç¨‹è§£å‹ä»£ç å’Œè§£æä»£ç ï¼š  
```c
/* è§£å‹ä»£ç  */
while(1){
    c = getchar();
    if (c == EOF){
        break;
    }else{
        len = getchar();
        c = getchar();
        while(len--){
            emit(c);
        }
    }
    emit(EOF);
}

/* è§£æä»£ç  */
while(1){
    c = getchar();
    if(c == EOF){
        break;
    }
    if(isalpha(c)){
        do{
            add_to_token(c);
            c = getchar();
        } while (isalpha(c));
        got_token(WORD);
    }
    add_to_token(c);
    got_token(PUNCT);
}
```  
ä¸¤æ®µä»£ç éƒ½å¾ˆç®€å•ï¼šä¸€ä¸ªåœ¨è°ƒç”¨`emit()` çš„æ—¶å€™äº§ç”Ÿå­—ç¬¦æ•°æ®;å¦ä¸€ä¸ªé€šè¿‡`getchar()` æ¶ˆè´¹æ•°æ®ã€‚å¦‚æœåªè¦åœ¨è°ƒç”¨`emit()` å’Œ`getchar()` çš„æ—¶å€™ï¼Œç¨‹åºå°±äº’ç›¸ç»™å¯¹æ–¹å‘é€æ•°æ®ï¼Œé‚£å°±å¯ä»¥ç®€å•åœ°å°†ä¸¤æ®µä»£ç `ä¸²è”`ï¼Œå°±å¯ä»¥å®ç°è§£å‹(å™¨)çš„è¾“å‡ºç›´æ¥é€è‡³è§£æ(å™¨)ã€‚  
åœ¨è®¸å¤šç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿›(çº¿)ç¨‹é—´çš„`ç®¡é“`(pipes) è¿›è¡Œé€šä¿¡ã€‚`emit()` å‘ç®¡é“ä¸­æ”¾æ•°æ®ï¼Œ`getchar()` ä»ç®¡é“ä¸­è·å–æ•°æ®ï¼Œç®€å•ç²—æš´ï¼Œä½†æ˜¯å¤ªé‡äº†(*éœ€è¦å¼€è¾Ÿçº¿ç¨‹ï¼Œä¿å­˜å †æ ˆä¿¡æ¯*)ï¼Œå¯¹äºè¿™ä¹ˆç®€å•çš„ä»»åŠ¡ï¼Œå°±å±äºæ€é¸¡ç”¨ç‰›åˆ€äº†ã€‚  
æ‰€ä»¥åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°é’ˆå¯¹æ­¤ç±»é—®é¢˜çš„ä¸€ç§éå¸¸æœ‰åˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆã€‚  

## é‡å†™  
ä¸€èˆ¬æˆ‘ä»¬ä¼šé‡å†™é€šä¿¡çš„å…¶ä¸­ä¸€ç«¯(*å°±æ˜¯ä»»æ„ä¸€æ®µä»£ç *)ï¼Œä½¿å…¶å¯ä»¥è¢«è°ƒç”¨ã€‚å¦‚ä¸‹ï¼š  
```c  
/* è§£å‹å™¨ */
int decompressor(void){
    // é™æ€å˜é‡ï¼Œç”¨äºä¿å­˜ç°åœº
    static int repchar;
    static int replen;
    
    if(replen > 0){
        replen --;
        return repchar;
    }
    c = getchar();
    if(c == EOF){
        return EOF;
    }
    if(c == 0xFF){
        replen = getchar();
        repchar = getchar();
        replen--;
        return repchar;
    }else{
        return c;
    }
}

/* è§£æå™¨ */
void parser(int c){
    static enum{
        START,
        IN_WORD
    } state;

    switch(state){
        case IN_WORD:
            if(isalpha(c)){
                add_to_token(c);
                return;
            }
            got_token(WORD);
            state = START;
            // è·Œè½
        case START:
            add_to_token(c);
            if(isalpha(c)){
                state = IN_WORD;
            }else{
                got_token(PUNCT);
            }
            break;
    }
}
```  
ä¸¤æ®µä»£ç åªéœ€é‡å†™ä¸€ä¸ªå°±è¡Œï¼šå¦‚æœé‡å†™äº†è§£å‹å™¨ï¼Œæ¯æ¬¡è°ƒç”¨å°±ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ï¼Œè§£æå™¨å°±å¯ä»¥ç”¨`decompressor()` å‡½æ•°æ›¿æ¢æ‰`getchar()`ï¼Œè¿™æ ·æ¯æ¬¡è§£æå™¨éœ€è¦å­—ç¬¦æ—¶å°±ä¼šè°ƒç”¨è§£å‹å™¨ç”Ÿäº§å­—ç¬¦ï¼Œçš†å¤§æ¬¢å–œ(*ç±»ä¼¼äºè½®è¯¢ï¼Œä½†æ˜¯å‡½æ•°é—´çš„è·³è½¬ä¼šæ¶‰åŠåˆ°å¤§é‡çš„æ ˆæ“ä½œï¼Œè¿˜æ˜¯æ¯”è¾ƒé‡*)ã€‚éº»ç“œæ‰ä¼šä¸¤ä¸ªéƒ½é‡å†™~  
å¦å¤–ï¼Œè¢«è°ƒç”¨è€…ä¸å¥½çœ‹å‘€(*ä½œè€…è¿™ä¹ˆä¸ªæ„æ€ï¼Œæˆ‘è§‰å¾—æŒºæ¸…æ™°çš„å•Š*)  

## Knuth's coroutines  
åœ¨ã€Šè®¡ç®—æœºç¼–ç¨‹è‰ºæœ¯ã€‹ä¸€ä¹¦ä¸­ï¼ŒDonald Knuth å±•ç¤ºäº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼š**å®Œå…¨æŠ›å¼ƒäº†æ ˆçš„æ¦‚å¿µ**ã€‚æ²¡æœ‰è°ƒç”¨è€…ï¼Œä¹Ÿæ²¡æœ‰è¢«è°ƒç”¨è€…ï¼Œåªè€ƒè™‘äºŒè€…çš„åˆä½œå…³ç³»ã€‚

> å› ä¸º`call` ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œéœ€è¦å°†å…¶å‚æ•°ä¸è¿”å›å€¼è¿›è¡Œå‹æ ˆ/å‡ºæ ˆæ“ä½œï¼Œæ‰€ä»¥é‡‡å–ä¸€ç§æ›´è½»é‡åŒ–çš„`call`ï¼šåœ¨æ±‡ç¼–å±‚é¢ä¸ŠæŒ‡å®šè¿”å›å€¼çš„åœ°å€ï¼Œç„¶ååˆ©ç”¨`jmp`æ›¿ä»£`call`ï¼Œè¿™æ ·ä¾¿çœå»äº†æ ˆæ“ä½œã€‚ä½†æ˜¯ ***ä¸å¯ç§»æ¤***  

## åŸºäºæ ˆçš„åç¨‹  
æ‰€ä»¥å˜ï¼Œæ¥å—ç°å®å§ï¼šåœ¨C è¯­è¨€å±‚é¢ä¸Šï¼Œåªèƒ½ç”±ä¸€ä¸ªå‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨è€…å¾ˆå®¹æ˜“å®ç°ï¼Œä½†æ˜¯è¦å®ç°è¢«è°ƒç”¨è€…`return` åè¿˜èƒ½ç»§ç»­æ‰§è¡Œå°±ä¸å®¹æ˜“äº†(*ä»å‡½æ•°`retrun` ~~å†æ¬¡è¢«è°ƒç”¨æ—¶è¿˜èƒ½ä¿å­˜ä¸Šä¸€æ¬¡çš„è¿è¡ŒçŠ¶æ€ã€‚ä¼¼ä¹ä¹Ÿä¸éš¾å•Šï¼Œ`static` å˜é‡ä¸è¡Œå˜›~~ åè¿˜èƒ½æ¥ç€æ‰§è¡Œ*)ï¼Œå¦‚ä¸‹ä»£ç ï¼š  
```c  
int function(void){
    int i;
    for(i=0;i<10;i++){
        return i;  // å½“ç„¶ä¸ä¼šæˆåŠŸï¼Œå¦åˆ™å°±æ´»è§é¬¼äº†
    }
}

// åˆ©ç”¨goto å®ç°
int function(void){
    static int i, state = 0;
    switch(state){
        case 0: goto LABEL0;
        case 1: goto LABEL1;
    }
    LABEL0:  // æ ‡ç­¾0
        for(i=0;i<10;i++){
            state = 1;
            return 1;
            LABEL1:;  // æ ‡ç­¾1
            // å†æ¬¡è°ƒç”¨æ—¶å°±ä¼šé€šè¿‡switch ç›´æ¥è·³è½¬åˆ°LABEL1
        }
}
/**
* è™½ç„¶æœ‰å¾ˆå¤šæ ‡ç­¾ï¼Œä½†ç¡®å®å¯ä»¥è¿è¡Œ~~~ 
* å°±â€¦â€¦æƒ³èµ·äº†ä¸€ä¸ªæ®µå­
* C++ï¼šä½ é€ äº†ä¸€åŒ¹é©¬ï¼Œå®ƒå¾ˆä¸‘ï¼Œè€Œä¸”çœ‹èµ·æ¥æ‘‡æ‘‡æ¬²å ï¼Œä½†èƒ½å¹²æ´»ã€‚
* Javaï¼šä½ éå¸¸æƒ³é€ ä¸€åŒ¹é©¬ï¼Œä½†é¦–å…ˆï¼Œä½ éœ€è¦é€ ä¸€ä¸ªé©¬å©ã€‚
* JavaScriptï¼šä½ å‡‘é½äº†æ‰€æœ‰é€ é©¬éœ€è¦çš„éƒ¨ä»¶ï¼ˆæ¡†æ¶ï¼‰ï¼Œä½†é©¬çš„éª¨æ¶ä¸­å¤šå‡ºäº†ä¸€ä¸ªè§’ï¼ˆAngularï¼‰ï¼Œå®ƒç˜«ç—ªäº†ã€‚
* NoSQLï¼Ÿï¼Ÿï¼Ÿï¼šä½ å·²ç»æœ‰äº†ä¸€åŒ¹åˆå¿«åˆæ¼‚äº®çš„é©¬ï¼Œä½†ä½ ä¸çŸ¥é“å®ƒåˆ°åº•åœ¨å“ªã€‚
* COBOLï¼šä½  1962 å¹´å°±é€ å¥½äº†è¿™åŒ¹é©¬ï¼Œä½†å®ƒåªèƒ½è¢«åˆ›é€ è€…é©¯æœï¼Œå¯¹å…¶ä»–äººæ¥è¯´ï¼Œå®ƒæ˜¯æ¡é¾™ã€‚
* LISPï¼šä¸è§£é‡Šâ€¦â€¦
* C#ï¼šè¿™åŒ¹é©¬ä¼ªè£…æˆéª†é©¼æ—¶è¡¨ç°æå¥½ï¼Œä½†å½“ä½ æŠŠå®ƒå½“é©¬ç”¨æ—¶ï¼Œå®ƒå˜å¾—å¾ˆæŒ‘å‰”ï¼ˆéš¾ä¼ºå€™ï¼‰ã€‚
* Assemblyï¼šè™½ç„¶è¿™åŒ¹é©¬çœ‹èµ·æ¥å¾ˆä½çº§ï¼Œä½†å®ƒä¹Ÿèƒ½è·‘(è€Œä¸”è·‘å¾—é£å¿«å¥½å§)ã€‚
* PHPï¼šä½ é€ äº†ä¸€åŒ¹ç‰¹æ´›ä¼Šæœ¨é©¬ï¼Œå®ƒæ¯å¤©ç”Ÿäº§æ•°ç™¾åŒ¹å°é©¬æ¥æƒ©ç½šä½ ã€‚
*/
```
å¥½å§ï¼Œæˆ‘ä»¬è®¨åŒæ‰‹å·¥å»ç»´æŠ¤è¿™ä¹ˆä¸€å †æ ‡ç­¾ï¼ç¨‹åºå‘˜æ°¸ä¸ä¸ºå¥´ï¼ï¼ï¼(*ä¹°çƒŸå»~~~*)

## è¾¾å¤«è®¾å¤‡  
> è¿™ä¸ªæ“ä½œå®åœ¨æ˜¯å¤ªä¼˜ç§€äº†ï¼Œæ®è¯´**ç¬¬ä¸€æ¬¡çœ‹åˆ°å°±èƒ½æ¥å—**ä¸‹é¢è¿™æ®µä»£ç çš„äººï¼Œå¦‚æœä¸æ˜¯å¯¹ç¼–è¯‘å™¨éå¸¸äº†è§£ï¼Œé‚£ä¹ˆå°±æ˜¯å¯¹ç¼–ç¨‹ä¸€çªä¸é€šï¼š  
```c
// æœ€æ—©è¾¾å¤«è®¾å¤‡æ˜¯ç”¨æ¥åœ¨å†…å­˜ä¸­æ‹·è´æ•°æ®çš„ï¼Œåˆ©ç”¨switch çš„è·Œè½ç‰¹æ€§ï¼Œå‡å°‘å¾ªç¯ä¸­while åˆ¤æ–­çš„æ¬¡æ•°
// å› ä¸ºå¦‚æœå¾ªç¯ä½“çš„æ“ä½œæ¯”è¾ƒå°‘çš„åŒ–ï¼Œåˆ¤æ–­ä½“å¯¹æ€§èƒ½çš„å½±å“å°±ä¼šæ˜¾å¾—éå¸¸é‡è¦
// è‡³äºä¸ºä»€ä¹ˆè¦ä½™8ï¼Ÿåæ­£ä½™å…¶ä»–çš„å€¼ä¹Ÿä¸æ˜¯ä¸è¡Œ
// *to = *from++; çš„æ„æ€å°±æ˜¯å°†from æŒ‡å‘çš„æ•°æ®è½¬ç§»åˆ°to æŒ‡å‘çš„ä½ç½®ï¼Œç„¶åfrom æŒ‡é’ˆåç§»(è‡ªå¢)
switch(count % 8){
    case 0:
    do {
        *to = *from++;
        case 7: *to = *from++;
        case 6: *to = *from++;
        case 5: *to = *from++;
        case 4: *to = *from++;
        case 3: *to = *from++;
        case 2: *to = *from++;
        case 1: *to = *from++;
        // æ³¨æ„ï¼šæ²¡æœ‰ break; å“¦
    }while((count-=8)>0);
}
```
æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨`switch` æ›¿æ¢æ‰`goto`ï¼š

```c  
int function(void){
    static int i, state = 0;
    switch(state){
        case 0:
        for(i=0;i<10;i++){
            state = 1;
            return 1;
            case 1:
            // ç»§ç»­æ‰§è¡Œçš„è¯­å¥
            ;
        }
    }
}
// å¦‚æœç”¨å®å®šä¹‰æ›¿æ¢æ‰è¿™äº›èŠ±é‡Œèƒ¡å“¨çš„ç»“æ„å°±æ›´å¥½äº†
#define crBegin static int state = 0;\
    switch(state){\
        case 0:

#define crReturn(i,x) do{\
    state = i;\
    return x;\
    case i:;\
    }while(0)
// ä½¿ç”¨do...while(0)çš„åŸå› ï¼šå½“crReturn åœ¨ifâ€¦â€¦elseâ€¦â€¦ ä¸­è°ƒç”¨æ—¶ï¼Œå¯ä»¥ä¸å¸¦èŠ±æ‹¬å·
// åœ¨å®å®šä¹‰æ—¶å¾ˆå¸¸ç”¨çš„ç»†èŠ‚
// if(true)
//     do{}while(0);
#define crFinish }

int function(void){
    static int i;
    crBegin;
    for(i=0;i<10;i++)
        crReturn(1,i);
    crFinishi;
}
```  
Perfectï¼Œä½†è¦æ³¨æ„ä¸€äº›è§„åˆ™ï¼š  
    1. ç”¨`crBegin` å’Œ`crFinish` åŒ…å›´å‡½æ•°ä½“ï¼›  
    2. æ‰€æœ‰éœ€è¦ä¿ç•™çš„å˜é‡éƒ½å£°æ˜ä¸º`static`ï¼›  
    3. ä¸è¦å°†`crReturn` æ”¾åœ¨æ˜¾å¼çš„`switch` è¯­å¥ä¸­ï¼›(*æ˜¾è€Œæ˜“è§ï¼Œå› ä¸ºä¼šæ‰°ä¹±è¾¾å¤«è®¾å¤‡*)  
    4. ä½†æ˜¯è¿™äº›éƒ½è¿˜å¯ä»¥æ¥å—ï¼Œæ¯•ç«Ÿâ€¦â€¦è¦å•¥è‡ªè¡Œè½¦å•Šï¼  
ç„¶åè¿˜è¦åœ¨`crReturn(i,x)` ä¸­æŒ‡å®šå‚æ•°`i`ï¼Œéš¾å—ï¼Œä½†æ˜¯ä¹Ÿæœ‰æ–¹æ³•è§£å†³ï¼šANSI C æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„å®å®šä¹‰`__LINE__`ï¼Œè¡¨ç¤ºå½“å‰è¡Œå·  
```c
// æ³¨æ„è¦ä¿è¯å®å‘½ä»¤åœ¨ä¸€è¡Œï¼è°ƒç”¨æ—¶crReturn ä¸è¦åœ¨åŒä¸€è¡Œ
#define crReturn(x) do{\
    state = __LINE__;\
    return x;\
    case __LINE__:;\
    }while(0);
```

## è¯„ä»·  
ç”¨ä¸Šé¢æåˆ°çš„å®å‘½ä»¤é‡å†™`ç”Ÿäº§è€…-æ¶ˆè´¹è€…`ï¼Œä¸è¦å¤šæƒ³ï¼Œç”¨å°±è¡Œäº†:
```c
// è§£å‹å™¨
int decompressor(void){
    static int c,len;  // è¦ä¿å­˜çš„ç¯å¢ƒå˜é‡å£°æ˜åœ¨æœ€å‰
    crBegin;  // å‡½æ•°å¼€å§‹
    while(1){
        c = getchar();
        if(c == EOF){
            break;
        }
        if(c == 0xFF){
            len = getchar();
            c = getchar();
            while(len--){
                crReturn(c);  // è¿”å›å¹¶ç»§ç»­
            }
        }else{
            crReturn(c);  // è¿”å›å¹¶ç»§ç»­
        }
    }
    crReturn(EOF);  // è¿”å›å¹¶ç»§ç»­
    crFinish;  // å‡½æ•°ç»“æŸ
}
//è§£æå™¨
void parser(int c){
    crBegin;  // å‡½æ•°ä½“å¼€å§‹
    while(1){  // ä¸­é—´ç”¨crReturn è¿”å›å€¼
        if(c == EOF){
            break;
        }
        if(isalpha(c)){
            do{
                add_to_token(c);
                crReturn();
            }while(isalpha(c));
            got_token(WORD);
        }
        add_to_token(c);
        got_token(PUNCT);
        crReturn( );
    }
    crFinish;  // å‡½æ•°ä½“ç»“æŸ
}
// å¦‚æœå±•å¼€ä¸ºc ä»£ç ï¼Œè‚¯å®šäº²å¦ˆéƒ½ä¸è®¤è¯†ğŸ‘‡
void parser(int c){
    static int state = 0;
    switch(state){
        case 0:
        while(1){  // ä¸­é—´ç”¨crReturn è¿”å›å€¼
            if(c == EOF){
                break;
            }
            if(isalpha(c)){
                do{
                    add_to_token(c);
                    do{state = __LINE__;return ;case __LINE__:;}while(0);  // è¦ä¿è¯åœ¨ä¸€è¡Œ
                }while(isalpha(c));
                got_token(WORD);
            }
            add_to_token(c);
            got_token(PUNCT);
            do{state = __LINE__;return ;case __LINE__:;}while(0);  // è¦ä¿è¯åœ¨ä¸€è¡Œ
        }
    }
}
```
æˆ‘ä»¬æŠŠä¸¤ä¸ªæ–¹æ³•éƒ½é‡å†™äº†ï¼Œä½†å…¶å®æ ¹æœ¬æ²¡å¿…è¦ã€‚åªéœ€è¦å¯¹åº”çš„å°†`crBegin`,`crReturn(x)`,`crFinish` æ›¿æ¢åŸå…ˆå‡½æ•°çš„ä»£ç å°±å¥½äº†ã€‚*è¿™é‡Œçš„è¯ä¼¼ä¹åªå®ç°äº†`Python` é‡Œé¢çš„`generator` çš„åŠŸèƒ½ï¼Œå¦‚æœéœ€è¦èµ‹åˆå€¼ï¼Œè¯·å‚ç…§`parser(int c)`å®ç°ï¼Œç¦»åç¨‹è¿˜æœ‰äº›è·ç¦»å§*  
> æ„Ÿè§‰ï¼Œå¦‚æœè¦å®ç°ç±»ä¼¼ä¸çº¿ç¨‹ï¼Œæ— é˜»å¡çš„æ•ˆæœï¼Œè¿˜éœ€è¦ä¸€ä¸ª`è°ƒåº¦å™¨`æ¥è°ƒåº¦å®šä¹‰çš„`åç¨‹`æˆ–è€…è¯´æ˜¯`generator`ï¼Œå°±æ˜¯ï¼š***å½“ä¸€ä¸ªåç¨‹æ˜¯é˜»å¡çŠ¶æ€æ—¶ï¼Œè°ƒåº¦å™¨ä¼šç›´æ¥å»æ‰§è¡Œåœ¨æ’é˜Ÿçš„åç¨‹***  

## ä»£ç é£æ ¼  
éªšæ“ä½œæ€»æ˜¯å®¹æ˜“é—ªç€è…°ï¼Œæ‰€ä»¥åœ¨å…¬å¸é¡¹ç›®ä¸­è¿™æ ·ç©å¾ˆå¯èƒ½ä¼šè¢«æŒ‰åœ¨åœ°ä¸Šæ‘©æ“¦ï¼šå®å®šä¹‰ä¸­èŠ±æ‹¬å·ä¸åŒ¹é…ï¼›ä¸åŒ…å«å­å—çš„`case`ï¼›`crReturn` ä¸­å†…å®¹ä¸å®Œæ•´â€¦â€¦ You should be ashamed of yourself.(*æ„Ÿè§‰ç†è§£ä¸äº†å•Šï¼Œå…¶å®ä½œè€…è¿™é‡Œæ˜¯****æ¬²æ‰¬å…ˆæŠ‘***)  
å½“ç„¶è¿™é‡Œçš„ç¤ºä¾‹ä»£ç å¹¶ä¸ç®—é•¿ï¼Œæ‰€ä»¥å³ä½¿ä½¿ç”¨çŠ¶æ€æœºé‡å†™ä¹Ÿèƒ½çœ‹æ‡‚ï¼Œä½†æ˜¯éšç€ä»£ç é•¿åº¦çš„å¢åŠ ï¼Œæƒ…å†µå°±ä¼šå˜å¾—ç³Ÿç³•â€¦â€¦  

æƒ³ä¸€ä¸‹ï¼Œä¸€ä¸ªå‡½æ•°ç”±ä¸‹é¢çš„ä»£ç æ„æˆ
```c
case STATE1:
    if(condition)state = STATE2;else state = STATE3;
```
å…¶å®å¯¹äºè¯»è€…è€Œè¨€ï¼Œå’Œä¸‹é¢çš„å·®åˆ«ä¹Ÿä¸å¤§ï¼š
```c
case STATE1:
    if(condition)goto LABEL2;else goto LABEL3;
```
ä½†æ˜¯ç›¸è¾ƒäºåè€…ï¼Œè¿™ç§ç ´åäº†ç®—æ³•å¸ƒå±€çš„ç»“æ„æ¥è¯´ï¼Œä½¿ç”¨å®å®šä¹‰çš„åç¨‹ï¼Œè¿˜ä¸ç®—æ˜¯æœ€åçš„é€‰æ‹©ã€‚

ç¼–ç¨‹è§„èŒƒæ˜¯ä¸ºäº†æ¸…æ™°ï¼Œå°†`switch`,`return`,`case` è¿™äº›é‡è¦çš„ä¸œè¥¿éšè—åˆ°"ä¸æ¸…æ™°"çš„`å®` ä¸­ï¼Œè™½ç„¶çœ‹èµ·æ¥ç ´åäº†è¯­æ³•ç»“æ„ï¼Œä½†æ˜¯å´çªå‡ºäº†ç®—æ³•ç»“æ„ã€‚(*å¯èƒ½å¯¹äºåˆå­¦è€…ï¼Œå°¤å…¶æ˜¯æƒ³å¿«é€ŸæŒæ¡ä¸€äº›æŠ€èƒ½çš„äººæ¥è¯´ï¼Œå°±ä¸é‚£ä¹ˆå¥½ç†è§£*)
ç®—æ³•çš„æ¸…æ™°åº¦è¦æ¯”è¯­æ³•çš„æ¸…æ™°åº¦æ›´é‡è¦äº›ã€‚  
> å…¶å®åŸæ–‡è¦æœ‰æ„æ€å¾—å¤šï¼Œå¯ä»¥å‚è€ƒ[å¼€æºä¸­å›½çš„ç¿»è¯‘](https://www.oschina.net/translate/coroutines-in-c?cmp&p=2)  

## æ”¹è‰¯  
åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå› ä¸ºä¾èµ–é™æ€å˜é‡ï¼Œæ‰€ä»¥è¿™ç§åç¨‹ç”¨çš„å¾ˆå°‘ï¼šä¸æ”¯æŒé‡å…¥å’Œå¤šçº¿ç¨‹ã€‚ç†æƒ³çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬ä¼šéœ€è¦åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°ï¼Œå¯¹äºä¸åŒä¸Šä¸‹æ–‡çš„è°ƒç”¨å¦‚æœè¿˜æ˜¯ç»§ç»­ä¹‹å‰çš„æ“ä½œå°±æœ‰éº»çƒ¦äº†ã€‚(**é‡å…¥é—®é¢˜**)
å¯ä»¥æ–°å¢ä¸€ä¸ªæŒ‡å‘ä¸Šä¸‹æ–‡çš„æŒ‡é’ˆä½œä¸ºå‡½æ•°çš„å‚æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ä¸å¤ªæ¼‚äº®ã€‚å¼ºè¿«ç—‡è¡¨ç¤ºï¼šå¾ˆå®šè¿˜æœ‰æ›´æ™šä¹ˆçš„è§£å†³æ–¹æ¡ˆï¼å¥½å§å¹¶æ²¡æœ‰â€¦â€¦
> ä½œè€…è¿™é‡Œæåˆ°äº†`Pascal` ä¸­çš„`with` è¿˜æœ‰`C++` ä¸­çš„ç±»å°è£…ï¼Œä½†æ˜¯å¾ˆé—æ†¾C å¹¶ä¸æ”¯æŒã€‚æƒ³æƒ³ä¹Ÿæ˜ç™½ï¼Œå› ä¸ºC è¯­è¨€ä¸­å¹¶æ²¡æœ‰ç±»çš„æ¦‚å¿µï¼Œæ‰€ä»¥è¿è¡Œç¯å¢ƒ/ä¸Šä¸‹æ–‡è¿™ç§ä¸œè¥¿ä¹Ÿæ²¡æœ‰æ¥ç”±ã€‚å€’æ˜¯å¯ä»¥é€šè¿‡ç»“æ„ä½“æ¥å®ç°`ç»§æ‰¿`,`å¤šæ€`çš„ç‰¹æ€§ï¼Œä½†æ˜¯æ”¾åœ¨è¿™é‡Œç¯‡å¹…å°±å¤ªé•¿äº†ã€‚å¥½å§ï¼Œä¸æƒ³é‚£ä¹ˆå¤šï¼Œ åæ­£å°±æ˜¯ï¼šå…¶å®é«˜çº§è¯­è¨€çš„ç‰¹æ€§ï¼Œæœ‰äº›ç”¨C ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„  

ä½œè€…è¿™é‡Œæä¾›äº†ä¸€ä¸ªCè¯­è¨€çš„å¤´æ–‡ä»¶[coroutine.h(MIT-Licensed)](https://www.chiark.greenend.org.uk/~sgtatham/coroutine.h)ï¼ŒåŒ…å«ä¸¤ä¸ªå®å®šä¹‰ï¼š`scr`ï¼Œç”¨äºå¯ä»¥ä½¿ç”¨é™æ€å˜é‡çš„æƒ…å†µï¼›`ccr`ï¼Œæ”¯æŒé‡å…¥ã€‚æ–‡æ¡£è¯´æ˜åŒ…å«åœ¨å¤´æ–‡ä»¶ä¸­ã€‚æœ‰é—®é¢˜çš„è¯ä¹Ÿå¯ä»¥é€šè¿‡[é‚®ç®±](mailto:anakin@pobox.com)è”ç³»ä½œè€….  

âš ï¼šVC6 ä¸æ”¯æŒè¿™ç§åç¨‹çš„å®ç°æ–¹å¼ï¼Œé»˜è®¤è°ƒè¯•çŠ¶æ€ä¸‹`__LINE__` è¿™ä¸ªå®å‘½ä»¤å¹¶ä¸èƒ½è¢«å¾ˆå¥½çš„æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨VC6 ä¸­éœ€è¦å…³æ‰"Edit and Continue" é€‰é¡¹ã€‚(é¡¹ç›®è®¾ç½® â€”â€” C/C++ â€”â€” General â€”â€” Debuginfo â€”â€”  åªè¦ä¸é€‰"Program Database for Edit and Continue"å°±è¡Œäº†)  

*æ„Ÿè°¢é˜…è¯»ï¼Œåˆ†äº«æœ‰è¶£*

## å‚è€ƒ  

- Donald Knuth, The Art of Computer Programming, Volume 1. Addison-Wesley, ISBN 0-201-89683-4. Section 1.4.2 describes coroutines in the "pure" form.
- http://www.lysator.liu.se/c/duffs-device.html is Tom Duff's own discussion of Duff's device. Note, right at the bottom, a hint that Duff might also have independently invented this coroutine trick or something very like it.  
**Update, 2005-03-07:** Tom Duff confirms this in a blog comment. The "revolting way to use switches to implement interrupt driven state machines" of which he speaks in his original email is indeed the same trick as I describe here.

- PuTTY is a Win32 Telnet and SSH client. The SSH protocol code contains real-life use of this coroutine trick. As far as I know, this is the worst piece of C hackery ever seen in serious production code.